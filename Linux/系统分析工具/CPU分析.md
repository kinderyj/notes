CPU相关的常用分析工具
==================

1. top (通用)
------------

可以实时动态的查看系统运行情况, 监测系统性能和运行信息，常用可选参数如下:

* -c：显示完整的命令；
* -d：屏幕刷新间隔时间；  
* -i<时间>：设置间隔时间；
* -u<用户名>：指定用户名；
* -p<进程号>：指定进程；
* -n<次数>：循环显示的次数。

top 命令的输出， 前5行是系统整体的统计信息，其中

load average表示系统在过去1分钟5分钟15分钟的任务队列的平均长度。这个值越大就表示系统CPU越繁忙。

Cpu(s):

5.0%us（用户空间占用的cpu百分百），

5.0%sy（系统空间占用的cpu百分比），

0.0%ni（用户进程空间内改变过优先级的用户占用的cpu百分比），

90.0%id（空闲cpu的百分比），

1.0%wa（等待输入输出cpu的百分比）。

Mem：817280k buffers（用作内核缓存的内存量）。

Swap：磁盘交换区容量

zombie 表示系统中僵尸进程的数量，可以进一步通过ps命令查出僵尸进程：

ps -A -o stat,ppid,pid,cmd | grep -e '^[Zz]'

该ps命令选项说明:

-A 参数列出所有进程

-o 自定义输出字段  stat（状态）, ppid（进程父id）, pid(进程id)，cmd（命令）

状态为 z或者Z的进程为僵尸进程

2. strace (分析程序)
------------

strace可以跟踪到一个进程产生的系统调用，包含参数、返回值、执行消耗的时间。

strace的常用的选项以及选项对应的含义如下：
 
* -c 统计每一系统调用的所执行的时间,次数和出错的次数等
* -f 跟踪由fork调用所产生的子进程
* -t 在输出中的每一行前加上时间信息
* -tt 在输出中的每一行前加上时间信息（微妙级） 
* -T 显示每一调用所耗的时间
* -e trace=set 只跟踪指定的系统调用。例如:-e trace=open,close,read,write表示只跟踪这四个系统调用。默认的为set=all
* -e trace=file 只跟踪有关文件操作的系统调用
* -e trace=process 只跟踪有关进程控制的系统调用
* -e trace=network 跟踪与网络有关的所有系统调用
* -e strace=signal 跟踪所有与系统信号有关的 系统调用
* -e trace=ipc 跟踪所有与进程通讯有关的系统调用
* -o filename 将strace的输出写入文件filename 
* -p pid 跟踪指定的进程pid

实例：

strace cat /dev/null

每一行都是一条系统调用，等号左边是系统调用的函数名及其参数，右边是该调用的返回值。

strace -f -o loadconfigure-strace.txt -e execve ./test

查看test脚本里面执行的程序里面系统调用ececve的调用情况

3. vmstat(性能分析)
------------

vmstat是一个很全面的性能分析工具，可以观察到系统的进程状态、内存使用、虚拟内存使用、磁盘的 IO、中断、上下问切换、CPU使用等。

vmstat的输出如下：

procs：
- r：运行队列中进程数量，这个值也可以判断是否需要增加CPU。（长期大于1）

- b：因为io处于阻塞状态的进程数。

memory：

-swap：使用虚拟内存大小

-free：空闲物理内存大小

-buff：用作缓冲的内存大小

-cache：用作缓存的内存大小

swap：

si：每秒从交换区写到内存的大小，由磁盘调入内存

so：每秒写入交换区的内存大小，由内存调入磁盘

io：

- bi：从块设备读入的数据总量（读磁盘）（KB/s）

- bo：写入到块设备的数据总量（写磁盘）（KB/s）

system：

- in:每秒产生的中断次数

- cs：每秒产生的上下文切换次数

cpu：

- us：用户进程消耗的CPU时间百分比

- sy：内核进程消耗的CPU时间百分比

- wa：IO等待消耗的CPU时间百分比

- id：CPU处在空闲状态时间百分比

3. perf(性能调优)
------------

perf是Linux的性能调优工具。perf工具的常用命令包括top，record，report等。

perf top命令用来显示程序运行的整体状况。该命令主要用来观察整个系统当前的状态，比如可以通过查看该命令的输出来查看当前系统最耗时的内核函数或某个用户进程

perf record命令则用来记录指定事件在程序运行过程中的信息，而Perf report命令则用来报告基于前面record命令记录的事件信息生成的程序运行状况报告。

通常用命令perf record -g -p pid将进程在命令运行期间的各项指令运行所占CPU的比例存在perf.data里面（-g表示记录函数之间的调用关系）, 

再用perf report --call-graph --stdio将刚刚的统计结果展示出来。